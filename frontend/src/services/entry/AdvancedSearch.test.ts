import { AdvancedSearchResultAttrInfoFilterKeyEnum } from "../../apiclient/autogenerated";

import { formatAdvancedSearchPrams } from "./AdvancedSearch";

describe("formatAdvancedSearchPrams", () => {
  const baseParams = (() => {
    const params = new URLSearchParams();

    params.append("entity", "101");
    params.append("entity", "102");
    params.set("entry_name", "hoge");
    params.set("is_all_entities", "false");
    params.set("has_referral", "false");
    params.set("referral_name", "hoge");
    params.set(
      "attrinfo",
      JSON.stringify([
        {
          name: "hoge",
          filterKey: AdvancedSearchResultAttrInfoFilterKeyEnum.CLEARED,
          keyword: "",
        },
      ])
    );

    return params;
  })();

  test("set params", () => {
    const actual = formatAdvancedSearchPrams({
      entityIds: ["1", "2"],
      entryName: "entry_name",
      searchAllEntities: true,
      hasReferral: true,
      referralName: "referral_name",
      attrFilter: {
        attr1: {
          filterKey: AdvancedSearchResultAttrInfoFilterKeyEnum.CLEARED,
          keyword: "",
        },
      },
    });

    expect(actual.getAll("entity").map((e) => Number(e))).toEqual([1, 2]);
    expect(actual.get("entry_name")).toEqual("entry_name");
    expect(actual.get("is_all_entities")).toEqual("true");
    expect(actual.get("has_referral")).toEqual("true");
    expect(actual.get("referral_name")).toEqual("referral_name");
    expect(actual.get("attrinfo")).toEqual(
      JSON.stringify([
        {
          name: "attr1",
          filterKey: AdvancedSearchResultAttrInfoFilterKeyEnum.CLEARED,
          keyword: "",
        },
      ])
    );
  });

  test("set specified params partially", () => {
    const actual = formatAdvancedSearchPrams({
      entityIds: ["1", "2"],
    });

    expect(actual.getAll("entity").map((e) => Number(e))).toEqual([1, 2]);
    expect(actual.has("entry_name")).toBeFalsy();
  });

  test("overwrite base params", () => {
    const actual = formatAdvancedSearchPrams({
      entityIds: ["1", "2"],
      baseParams,
    });

    // overwritten
    expect(actual.getAll("entity").map((e) => Number(e))).toEqual([1, 2]);
    // base params
    expect(actual.get("entry_name")).toEqual("hoge");
    expect(actual.get("is_all_entities")).toEqual("false");
    expect(actual.get("has_referral")).toEqual("false");
    expect(actual.get("referral_name")).toEqual("hoge");
    expect(actual.get("attrinfo")).toEqual(
      JSON.stringify([
        {
          name: "hoge",
          filterKey: AdvancedSearchResultAttrInfoFilterKeyEnum.CLEARED,
          keyword: "",
        },
      ])
    );
  });
});
