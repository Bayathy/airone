import {
  EntryAttributeType,
  EntryAttributeTypeTypeEnum,
  EntryAttributeValue,
  EntryAttributeValueObject,
} from "../../apiclient/autogenerated";

type WithChecked = { checked: boolean };
type EntryFormAttributeValueAsObject = EntryAttributeValueObject & WithChecked;
type EntryFormAttributeValueAsGroup = EntryAttributeType & WithChecked;

type EntryFormAttributeValueAsNamedObject = {
  [key: string]: EntryFormAttributeValueAsObject;
};
type EntryFormAttributeValueAsArrayObject =
  Array<EntryFormAttributeValueAsObject>;
type EntryFormAttributeValueAsArrayNamedObject = Array<{
  [key: string]: EntryFormAttributeValueAsObject;
}>;
type EntryFormAttributeValueAsArrayGroup =
  Array<EntryFormAttributeValueAsGroup>;

type EntryFormAttributeValue = Pick<
  EntryAttributeValue,
  "asString" | "asArrayString" | "asBoolean"
> & {
  asObject?: EntryFormAttributeValueAsObject;
  asNamedObject?: EntryFormAttributeValueAsNamedObject;
  asArrayObject?: EntryFormAttributeValueAsArrayObject;
  asArrayNamedObject?: EntryFormAttributeValueAsArrayNamedObject;
  asArrayGroup?: EntryFormAttributeValueAsArrayGroup;
  asGroup?: EntryFormAttributeValueAsGroup;
};

export type EntryFormAttribute = Pick<
  EntryAttributeType,
  "id" | "type" | "schema"
> & {
  value: EntryFormAttributeValue;
};

export const ToEntryFormAttributes = (
  origin: Array<EntryAttributeType>
): Record<string, EntryFormAttribute> => {
  return Object.fromEntries(
    origin.map((attr) => {
      switch (attr.type) {
        case EntryAttributeTypeTypeEnum.GROUP:
          return [
            attr.schema.name,
            {
              id: attr.id,
              type: attr.type,
              schema: attr.schema,
              value: {
                asGroup: [
                  {
                    ...attr.value.asGroup,
                    checked: true,
                  },
                ],
              },
            },
          ];

        case EntryAttributeTypeTypeEnum.OBJECT:
          return [
            attr.schema.name,
            {
              id: attr.id,
              type: attr.type,
              schema: attr.schema,
              value: {
                asObject: [
                  {
                    ...attr.value.asObject,
                    checked: true,
                  },
                ],
              },
            },
          ];

        case EntryAttributeTypeTypeEnum.NAMED_OBJECT:
          const name = Object.keys(attr.value.asNamedObject ?? {})[0];
          const value = attr.value.asNamedObject?.[name];
          return [
            attr.schema.name,
            {
              id: attr.id,
              type: attr.type,
              schema: attr.schema,
              value: {
                asNamedObject: {
                  [name]: [
                    {
                      id: value?.id ?? 0,
                      name: value?.name ?? "",
                      checked: true,
                    },
                  ],
                },
              },
            },
          ];

        case EntryAttributeTypeTypeEnum.ARRAY_GROUP:
          return [
            attr.schema.name,
            {
              id: attr.id,
              type: attr.type,
              schema: attr.schema,
              value: {
                asArrayGroup: attr.value.asArrayGroup?.map((val) => [
                  {
                    ...val,
                    checked: true,
                  },
                ]),
              },
            },
          ];

        case EntryAttributeTypeTypeEnum.ARRAY_OBJECT:
          return [
            attr.schema.name,
            {
              id: attr.id,
              type: attr.type,
              schema: attr.schema,
              value: {
                asArrayObject: attr.value.asArrayObject?.map((val) => [
                  {
                    ...val,
                    checked: true,
                  },
                ]),
              },
            },
          ];

        case EntryAttributeTypeTypeEnum.ARRAY_NAMED_OBJECT:
          return [
            attr.schema.name,
            {
              id: attr.id,
              type: attr.type,
              schema: attr.schema,
              value: {
                asArrayNamedObject: attr.value.asArrayNamedObject?.map(
                  (val) => {
                    const name = Object.keys(val)[0];
                    const value = val[name];
                    return {
                      [name]: [
                        {
                          ...value,
                          checked: true,
                        },
                      ],
                    };
                  }
                ),
              },
            },
          ];

        case EntryAttributeTypeTypeEnum.BOOLEAN:
          return [
            attr.schema.name,
            {
              id: attr.id,
              type: attr.type,
              schema: attr.schema,
              value: { asBoolean: attr.value.asBoolean },
            },
          ];

        case EntryAttributeTypeTypeEnum.ARRAY_STRING:
          return [
            attr.schema.name,
            {
              id: attr.id,
              type: attr.type,
              schema: attr.schema,
              value: { asArrayString: attr.value.asArrayString },
            },
          ];

        case EntryAttributeTypeTypeEnum.STRING:
        case EntryAttributeTypeTypeEnum.TEXT:
          return [
            attr.schema.name,
            {
              id: attr.id,
              type: attr.type,
              schema: attr.schema,
              value: { asString: attr.value.asString },
            },
          ];

        default:
          throw new Error("unknown entry attribute type");
      }
    })
  );
};
